Description: demonstrate deployment of Slurm and Ganglia in a Virtual Cluster
HeatTemplateFormatVersion: '2012-12-12'
Outputs:
  NodeIP:
    Description: Ganglia deployment
    Value: 'Hello'
Parameters:
  MonitorPort: {Default: '8649', Type: String, Description: TCP port of monitoring traffic data}
  #RunList: {Default: ganglia, Type: String,
  #  Description: Collection of recipes to execute}
  NumberOfComputes:
    Description: "Number of compute nodes to launch"
    Type: String
    Default: '2'

## XLCLOUD default Params
 # xlcloud:defaultSubnetUuid: 
 #   Type: String
 #   ConstraintDescription: project doesn't have default subnet defined in XLcloud
 #   Description: Project's default subnet identifier
 #   Default: PENDING
 # xlcloud:defaultNetworkUuid: 
 #   Type: String
 #   ConstraintDescription: project doesn't have network defined in XLcloud
 #   Description: Project's network identifier
 #   Default: PENDING

  xlcloud:defaultImageId: 
    Type: String
    ConstraintDescription: must be a valid XLcloud image name.
    AllowedValues: 
    - F17-x86_64
    - F18-x86_64
    - F19-x86_64-chef-solo
    - cirros-0.3.1-x86_64-uec
    Description: Default image name for instances in this stack
    Default: F19-x86_64-chef-solo

  xlcloud:defaultInstanceType: 
    Type: String
    ConstraintDescription: must be a valid XLcloud instance type.
    AllowedValues: 
    - m1.tiny
    - m1.small
    - m1.medium
    - m1.large
    - m1.xlarge
    Description: Default instance type (flavor) for instances in this stack
    Default: m1.small

  xlcloud:defaultKeyName: 
    Type: String
    Description: Name of an existing EC2 KeyPair to enable SSH access

Resources:
  CfnUser: 
    Type: AWS::IAM::User

  MyKey:
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: {Ref: CfnUser}

  MonitorHandle:
    Type: AWS::CloudFormation::WaitConditionHandle

  MonitorReady:
    Type: AWS::CloudFormation::WaitCondition
    Properties:
      Handle: {Ref: MonitorHandle}
      Count: '1' 
      Timeout: '1600'

  Slurm:
    Type: AWS::CloudFormation::Stack
    DependsOn: MonitorReady
    Properties:
      Parameters: { #'MyKeyIam' : {Ref: MyKey}, 
                    'xlcloud:defaultKeyName' : {Ref: 'xlcloud:defaultKeyName'},
                    'xlcloud:defaultImageId' : {Ref: 'xlcloud:defaultImageId'},
                    'xlcloud:defaultInstanceType' : {Ref: 'xlcloud:defaultInstanceType'},
                    'xlcloud:monitorIP' : {'Fn::GetAtt': ['MonitorNode', 'Outputs.MonitorIP']},
                    'NumberOfComputes' : {Ref: NumberOfComputes}}
      TemplateURL : 'http://gitorious.ow2.org/xlcloud/heat-resources/blobs/raw/master/templates/layer-blueprints/slurm-layer.yaml'
      #TemplateURL : 'http://10.197.217.62/downloads/tpl/slurm-layer.yaml'
      TimeoutInMinutes: 10

  MonitorNode:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters: { #'MyKeyIam' : {Ref: MyKey}, 
                    'xlcloud:defaultKeyName' : {Ref: 'xlcloud:defaultKeyName'},
                    'xlcloud:defaultImageId' : {Ref: 'xlcloud:defaultImageId'},
                    'xlcloud:defaultInstanceType' : {Ref: 'xlcloud:defaultInstanceType'},
                    # give waithandler ref for cfn-signal
                    'MonitorHandle' : {Ref: 'MonitorHandle'},
                    'parentStackID' : {Ref: 'AWS::StackId'},
                    'parentIamAccessyKey' : {Ref: 'MyKey'},
                    'parentIamSecretKey' : {'Fn::GetAtt': ['MyKey', 'SecretAccessKey']},
                    'MonitorPort' : {Ref: MonitorPort}}
      TemplateURL : 'http://gitorious.ow2.org/xlcloud/heat-resources/blobs/raw/master/templates/layer-blueprints/ganglia-f19.yaml'
      #TemplateURL : 'http://10.197.217.62/downloads/tpl/ganglia-f19.yaml'
      TimeoutInMinutes: 5
